#!/usr/bin/env bash

set -eou pipefail

max() {
    local a="$1"
    local b="$2"
    if echo "${a} > ${b}" | bc >/dev/null; then
        echo "${a}"
    else
        echo "${b}"
    fi
}

get_gpu_max_memory_usage() {
    local my_pid=$1
    local max=$2
    local curr
    # Some processes might now use the GPU
    if ! nvidia-smi pmon -s m -c 1 -o T | grep "${my_pid}" >/dev/null 2>/dev/null; then
        echo "0"
        return
    fi
    curr=$(nvidia-smi pmon -s m -c 1 -o T | grep "${my_pid}" | awk '{print $5}' | sort | tail -1)
    max "${curr}" "${max}"
}

get_cpu_max_rss_memory_usage() {
    local my_pid=$1
    local max=$2
    local curr
    curr=$(cat "/proc/${my_pid}/smaps" | grep -i '^Rss' |  awk '{Total+=$2} END {print Total/1024""}')
    max "${curr}" "${max}"
}

get_cpu_max_pss_memory_usage() {
    local my_pid=$1
    local max=$2
    local curr
    curr=$(cat "/proc/${my_pid}/smaps" | grep -i '^Pss' |  awk '{Total+=$2} END {print Total/1024""}')
    max "${curr}" "${max}"
}

spin() {
  spinner="/|\\-/|\\-"
  while :
  do
    for i in `seq 0 7`
    do
      echo -n "${spinner:$i:1}"
      echo -en "\010"
      sleep 1
    done
  done
}

LOG_FILE=${LOG_FILE:-}
if [[ -z "${LOG_FILE}" ]]; then
  LOG_FILE=$(mktemp --suffix "_monitor_proc")
fi

COMMAND_TO_RUN=$@

echo "Running  ${COMMAND_TO_RUN} > \"${LOG_FILE}\" 2>&1 &"
${COMMAND_TO_RUN} > "${LOG_FILE}" 2>&1 &
PID_TO_WATCH=$(ps aux |  grep -v 'grep' | grep -F "${COMMAND_TO_RUN}" | grep -v "$0" | awk '{print $2}' | head -1)
trap "kill -9 ${PID_TO_WATCH}" $(seq 0 15)
MAX_GPU_MEMORY=0
MAX_RSS_MEMORY=0
MAX_PSS_MEMORY=0

echo "Watching PID: ${PID_TO_WATCH}"
echo "Tail log file with: "
echo "    tail -f ${LOG_FILE}"

spin &
SPIN_PID=$!
trap "kill -9 ${SPIN_PID}" $(seq 0 15)

while kill -0 "${PID_TO_WATCH}" >/dev/null 2>/dev/null; do
    MAX_GPU_MEMORY=$(get_gpu_max_memory_usage "${PID_TO_WATCH}" "${MAX_GPU_MEMORY}")
    MAX_RSS_MEMORY=$(get_cpu_max_rss_memory_usage "${PID_TO_WATCH}" "${MAX_RSS_MEMORY}")
    MAX_PSS_MEMORY=$(get_cpu_max_pss_memory_usage "${PID_TO_WATCH}" "${MAX_PSS_MEMORY}")
    sleep 0.5
done

echo
echo "Max GPU Memory Consumed: ${MAX_GPU_MEMORY} MB"
echo "Max RSS Memory Consumed: ${MAX_RSS_MEMORY} MB"
echo "Max PSS Memory Consumed: ${MAX_PSS_MEMORY} MB"
echo
